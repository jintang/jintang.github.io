title: 谷歌云部署个人网站
date: 2018-01-24 17:09:26
tags: 
- linux
- 云
categories: linux
---
>得知谷歌云免费的消息，喜出望外，毕竟阿里云腾讯云这些一年价格也不菲。赶紧申请了一个，想申请的抓紧了。废话不说了，跟我一起在谷歌云上部署一个个人网站吧。

假设你已经拥有了一个谷歌云账号。没有的话赶紧注册一个，需要一个**VISA**的信用卡，其他的都是基本信息填写。
## 谷歌云上创建 Compute Engine 实例
1. 点击[这里](https://console.cloud.google.com/compute/instances)进入 **Compute Engine** 页面
2. 选择 **创建实例**
    - 地区选`asia-east1-c`，据说对大陆玩家友好。
    - 机器类型：我选了 小型(一个共享vCPU) ，我部署的网站很小，所以这个就可以了
    - 启动磁盘——更改：选择 `CentOS7`，其他不用变。因为我要用到`mongodb`，如果选择`debian9`，`mongodb`的官网目前还不支持，为了在`debian9`上安装`mongodb`，我也是被折磨得很心累。然后果断在同事的建议下果断新建了个`CentOS7`的**实例**。当然你也可以选择其他的...
    - 管理、磁盘、网络、SSH密钥：需要改网络部分，如果你之前已经创建了**静态IP**，**外部IP**这一栏就选`临时`，如果没有创建的话，请选择`创建IP地址`。
3. 点击创建，结果如下：
    ![vm实例](http://7xphbb.com1.z0.glb.clouddn.com/google-cloud-vm.png)

<!-- more -->
## 创建部署的项目   
要在云服务器上部署一个网站，那首先肯定要从本地新建一个了。我选择了一个使用`node`和`mongodb`的博客系统，跟着**nswbmw**大神的[N-blog](https://github.com/nswbmw/N-blog)敲一遍，写完之后本地运行成功。感叹一下，大神的这个项目带了多少人走进了`node`。

如果不想关注创建项目，这儿就不用花费功夫，在下一步的时候可以直接使用大神的项目部署。

## 进入云服务器部署
**vm实例**右侧有个`ssh`按钮，点击就可以进入到后台。当然我们可以使用其他`ssh`工具登陆，那个`ssh`按钮右边有个小三角，点开之后选择**使用其他SSH客户端**，就可以进入教程。

关于`ssh`工具的选择，最具代表性的是**putty**，我选择使用**xshell**，因为它是中文版的，我英语不好...而且功能比**putty**强大很多。更多`ssh`工具的选择，请参考[这儿](https://llinmeng.github.io/2015/08/05/windows-ssh-tools-diff/)。

废话不多说，`ssh`登陆后开始下面的步骤：

*Tip:* 我的系统是`centOS7`，所以其他的系统会有稍微的区别，主要是包管理器的区别。如果是`debian`和`ubuntu`使用`apt-get`安装。

### 安装 Node.js
**方法1： **使用源码安装包安装，你也可以选择其他方式，目前的最新稳定版是`8.9.4`，以下安装`node`的版本是`8.9.4`
``` bash
sudo yum install wget
# 在官方网站（https://nodejs.org/zh-cn/download/）查看链接并下载源码
wget https://nodejs.org/dist/v8.9.4/node-v8.9.4.tar.gz
# 解压
tar xzvf node-v8.9.4.tar.gz
cd node-v8.9.4
# 安装编译环境并编译
sudo yum install gcc gcc-c++
./configure
make # 这一步时间比较长
# 安装node
sudo make install
# 检测安装是否成功，出现版本号就成功了
node --version
```
**方法2：**官方编译过的二进制数据包安装，更快速和方便
在[下载地址](https://nodejs.org/download/release/)选择要下载的版本，还是选择`8.9.4`
``` bash
wget https://nodejs.org/download/release/v8.9.4/node-v8.9.4-linux-x64.tar.gz
sudo tar --strip-components 1 -xzvf node-v8.9.4-linux-x64.tar.gz -C /usr/local
# 检测安装是否成功，出现版本号就成功了
node --version
```
### 安装mongodb
我们安装的**mongodb社区版**，根据[官方链接](https://docs.mongodb.com/manual/tutorial/install-mongodb-on-red-hat/)安装并启动。
### 添加项目
之前我们不是在本地跟着大神写了一个项目，我们可以通过**ftp**将刚刚那个项目上传上来，也可以安装个`git`直接克隆大神的项目进行部署。我们直接克隆好了，更方便...
``` bash
sudo yum update
sudo yum install git
git clone https://github.com/nswbmw/N-blog.git 
```
### 启动项目
``` bash
cd N-blog
npm i
vim config/default.js #修改端口 3000->80
sudo node index
# 成功的提示: myblog listening on port 80
```
如果成功了，那么访问你的**静态ip**这时候已经可以看到项目了。  
我在最后运行的时候出现了这个问题:
```
node command is undefined
```
因为`centOS`的安全策略，要运行 **80**端口必须以管理员身份运行，但在管理员身份下却获取不到`node`命令，解决办法是添加**环境变量**。
``` bash
# 切换为管理员
sudo -i 
# 获取node的位置
which node # 我的是在/usr/local/bin/node
# 编辑环境变量
vi /etc/profile
    # 在结尾处添加:
    PATH=$PATH:/usr/local/bin/ # 结尾到bin/就可以了，不是bin/node
    export PATH
    # 使环境变量生效
    source /etc/profile
# 检测是否生效，包含刚刚添加的表示生效了
echo $PATH   
node --version # 可以正确显示版本号  
```
经过上面的步骤，项目已经成功的跑了起来，访问**静态ip**已经可以看到项目。但如果关闭终端，我们的项目就又停止了，我们需要`pm2`作为守护进程启动博客

``` 
npm i pm2 -g
pm2 start index.js --name="myblog"
```
关闭终端，访问**静态ip**，我们的项目依旧在运行。

## 绑定域名
我们随便访问一个网站，地址栏里都输入的是域名，而非`IP`，所以我们也来个域名吧。
### 购买域名
购买域名可以去 [万网](https://wanwang.aliyun.com/)...因为我只是为了玩，所以在[景安网络](https://www.zzidc.com/main/huodong/doMainActivity/spreadid_138149_hdName_doMainActivity.html)买个1年便宜的`.top`域名。
### 域名解析
进入**域名控制面板**——选择**DNS解析管理**——**添加记录**:
![host](http://7xphbb.com1.z0.glb.clouddn.com/google-cloud-host.png)
我的域名是`cloud-tv.top`，为了让`www.cloud-tv.top`也可用，所以：  
- 主机记录就是域名前缀，常见用法有：
    - www：解析后的域名为 `www.cloud-tv.top`
    - 留空：直接解析主域名 `cloud-tv.top`
    - \*：泛解析，匹配其他所有域名 `*.cloud-tv.top`
- 记录类型与记录值(即解析地址)：
    - A记录：把`cloud-tv.top`解析到某一`ip`,则主机名留空,解析地址填该`ip`
    - CNAME记录：把`cloud-tv.top`解析到`www.cloud-tv.top`,则主机名填`www`,解析地址填该`cloud-tv.top`
    
### 检测解析完成
等几分钟一般就解析完了。检测方法：
``` bash
ping cloud-tv.top
```
当域名后面出现你绑定的`ip`时说明解析成功。  
更多域名解析的相关知识请自行百度。

**最后**：访问 http://cloud-tv.top 或 http://www.cloud-tv.top 就可以看到之前部署的项目了。

## 补充
![google-cost](http://7xphbb.com1.z0.glb.clouddn.com/google-cloud-cost.png)
刚心血来潮查看了一下谷歌云的花费，然后算一笔账。第一行是我开的一个微型主机（可供选择里面最小的），用来翻墙，算下来一年的费用是**$78.87**。第二行就是我开的一个比上面一个高一级的主机（也就是可选择主机里排倒数第二），用来部署个人网站，算下来一年的费用是**$481.65**。而且这只是主机运行的费用，不包含流量费。so...谷歌云送的**$300**不够啊...看来我得把两个主机合成一个，用最小型号的那个主机。果然...没钱是多么苦...
